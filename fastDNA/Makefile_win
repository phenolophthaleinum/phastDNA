#
# Copyright (c) 2016-present, Facebook, Inc.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree. An additional grant
# of patent rights can be found in the PATENTS file in the same directory.
#

# Define the C++ compiler and flags
CC = cl
CFLAGS = /EHsc /MT /std:c++17 /arch:AVX2 /O2 /DNDEBUG

# Define the object files
OBJS = args.obj dictionary.obj productquantizer.obj matrix.obj qmatrix.obj vector.obj model.obj utils.obj fasttext.obj

# Default target
all: fastdna

# Opt target
# CFLAGS = /O2 /DNDEBUG
# opt: fastdna

# # Debug target
# debug: CFLAGS = /Zi /Od
# debug: fastdna

# Object file rules
args.obj: src/args.cc src/args.h
	$(CC) $(CFLAGS) /c src/args.cc

dictionary.obj: src/dictionary.cc src/dictionary.h src/args.h
	$(CC) $(CFLAGS) /c src/dictionary.cc

productquantizer.obj: src/productquantizer.cc src/productquantizer.h src/utils.h
	$(CC) $(CFLAGS) /c src/productquantizer.cc

matrix.obj: src/matrix.cc src/matrix.h src/utils.h
	$(CC) $(CFLAGS) /c src/matrix.cc

qmatrix.obj: src/qmatrix.cc src/qmatrix.h src/utils.h
	$(CC) $(CFLAGS) /c src/qmatrix.cc

vector.obj: src/vector.cc src/vector.h src/utils.h
	$(CC) $(CFLAGS) /c src/vector.cc

model.obj: src/model.cc src/model.h src/args.h
	$(CC) $(CFLAGS) /c src/model.cc

utils.obj: src/utils.cc src/utils.h
	$(CC) $(CFLAGS) /c src/utils.cc

fasttext.obj: src/fasttext.cc src/*.h
	$(CC) $(CFLAGS) /c src/fasttext.cc

# Linking rule
fastdna: $(OBJS) src/fasttext.cc
	$(CC) $(CFLAGS) $(OBJS) src/main.cc /Fe:fastdna /link /LIBPATH:.

# Clean rule
clean:
	del *.obj fasttext
